---
phase: 04-react-islands-extraction
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - src/pages/test-all-islands.astro
  - tests/islands.spec.ts
autonomous: true

must_haves:
  truths:
    - "All 4 React islands render on a single page without conflicts"
    - "Navbar animation completes without hydration errors"
    - "FeatureCard animations trigger when scrolled into view"
    - "WaitlistForm accepts input and shows state changes"
    - "No hydration mismatch errors in browser console"
  artifacts:
    - path: "src/pages/test-all-islands.astro"
      provides: "Integration test page with all islands"
      min_lines: 50
    - path: "tests/islands.spec.ts"
      provides: "Playwright tests for hydration verification"
      min_lines: 40
  key_links:
    - from: "src/pages/test-all-islands.astro"
      to: "src/components/react/Navbar.tsx"
      via: "import with client:load"
      pattern: "Navbar.*client:load"
    - from: "src/pages/test-all-islands.astro"
      to: "src/components/react/WaitlistForm.tsx"
      via: "import with client:visible"
      pattern: "WaitlistForm.*client:visible"
---

<objective>
Create integration test page and Playwright tests to verify all React islands work together without hydration errors.

Purpose: Validate that all extracted components render correctly with their assigned hydration directives and no conflicts occur when multiple islands exist on the same page. This fulfills the Phase 4 success criteria: "No hydration mismatch errors in browser console."

Output:
- src/pages/test-all-islands.astro (combined test page)
- tests/islands.spec.ts (automated Playwright tests)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-react-islands-extraction/04-RESEARCH.md
@.planning/phases/04-react-islands-extraction/04-01-SUMMARY.md
@.planning/phases/04-react-islands-extraction/04-02-SUMMARY.md
@.planning/phases/04-react-islands-extraction/04-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration test page with all islands</name>
  <files>src/pages/test-all-islands.astro</files>
  <action>
Create a comprehensive test page that combines all extracted React islands to verify they work together.

This page mimics the structure of the final landing page but is used for testing during development.

```astro
---
// src/pages/test-all-islands.astro
// Integration test page for all React islands
import BaseLayout from '../layouts/BaseLayout.astro';
import Navbar from '../components/react/Navbar.tsx';
import HeroSection from '../components/react/HeroSection.tsx';
import FeatureCard from '../components/react/FeatureCard.tsx';
import WaitlistForm from '../components/react/WaitlistForm.tsx';
import Footer from '../components/Footer.astro';
---

<BaseLayout
  title="All Islands Integration Test"
  description="Testing all React islands together for hydration compatibility"
>
  <!-- Navbar: client:load (immediate interactivity) -->
  <Navbar client:load />

  <!-- HeroSection: client:idle (deferred until browser idle) -->
  <HeroSection client:idle />

  <!-- Features Section: client:visible (hydrate when scrolled into view) -->
  <section class="py-16 bg-gray-50">
    <div class="container mx-auto px-4">
      <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
        <FeatureCard
          client:visible
          icon="ClipboardList"
          title="Trip Planning & Management"
          description="Plan, manage, and collaborate on group trips with destination search and shared tools."
        />
        <FeatureCard
          client:visible
          icon="MessagesSquare"
          title="Real-time Communication"
          description="Stay connected with group chat, real-time messaging, media sharing, and read receipts."
        />
        <FeatureCard
          client:visible
          icon="LocateFixed"
          title="Location Services"
          description="Share live locations, explore interactive maps, and discover nearby places together."
        />
        <FeatureCard
          client:visible
          icon="Banknote"
          title="Financial Management"
          description="Track expenses effortlessly and split costs fairly among your travel group."
        />
      </div>
    </div>
  </section>

  <!-- Waitlist Section: client:visible -->
  <section id="waitlist" class="py-16 px-4">
    <div class="container mx-auto max-w-xl text-center">
      <h2 class="text-3xl font-bold mb-6">Join the Waitlist</h2>
      <p class="text-gray-600 mb-8">
        Be among the first to experience a better way to travel together.
        Get early access and exclusive updates.
      </p>
      <WaitlistForm client:visible />
    </div>
  </section>

  <!-- Footer: Static Astro (no hydration) -->
  <Footer />
</BaseLayout>
```

Key hydration strategy from research:
- Navbar: client:load (critical navigation)
- HeroSection: client:idle (animations not critical)
- FeatureCard: client:visible (below fold)
- WaitlistForm: client:visible (middle of page)
- Footer: No directive (static Astro)
  </action>
  <verify>
1. File exists: ls src/pages/test-all-islands.astro
2. All imports present: grep -c "import.*from" src/pages/test-all-islands.astro (should be 6)
3. Correct directives:
   - grep -q "Navbar client:load" src/pages/test-all-islands.astro
   - grep -q "HeroSection client:idle" src/pages/test-all-islands.astro
   - grep -q "FeatureCard.*client:visible" src/pages/test-all-islands.astro
   - grep -q "WaitlistForm client:visible" src/pages/test-all-islands.astro
  </verify>
  <done>
- test-all-islands.astro exists
- All 5 component types included
- Correct hydration directives applied
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Playwright tests for hydration verification</name>
  <files>tests/islands.spec.ts</files>
  <action>
Create Playwright tests to verify React islands hydrate correctly without errors.

Tests should verify:
1. No hydration mismatch errors in console
2. Navbar renders and is interactive
3. HeroSection renders with visible content
4. FeatureCards render (4 cards)
5. WaitlistForm accepts input
6. Footer renders as static HTML

```typescript
// tests/islands.spec.ts
import { test, expect } from '@playwright/test';

test.describe('React Islands Hydration', () => {
  test.beforeEach(async ({ page }) => {
    // Hide Astro dev toolbar to avoid test interference
    await page.addStyleTag({
      content: 'astro-dev-toolbar { display: none !important; }'
    });
  });

  test('all islands render without hydration errors', async ({ page }) => {
    // Collect console errors
    const consoleErrors: string[] = [];
    page.on('console', (msg) => {
      if (msg.type() === 'error') {
        consoleErrors.push(msg.text());
      }
    });

    await page.goto('/test-all-islands/');

    // Wait for hydration to complete (islands load async)
    await page.waitForTimeout(2000);

    // Check for hydration-specific errors
    const hydrationErrors = consoleErrors.filter(
      (err) => err.includes('hydration') || err.includes('Hydration')
    );

    expect(hydrationErrors).toHaveLength(0);
  });

  test('Navbar renders with client:load', async ({ page }) => {
    await page.goto('/test-all-islands/');

    // Navbar should be visible immediately
    const navbar = page.locator('nav');
    await expect(navbar).toBeVisible();

    // Check for NomadCrew logo text
    await expect(navbar.locator('text=NomadCrew')).toBeVisible();

    // Check for Join Waitlist button
    const joinButton = navbar.locator('text=Join Waitlist');
    await expect(joinButton).toBeVisible();
  });

  test('HeroSection renders content', async ({ page }) => {
    await page.goto('/test-all-islands/');

    // Check for main heading
    await expect(page.locator('h1')).toContainText('Group Travel App');

    // Check for CTA button
    const ctaButton = page.locator('text=Get Early Access');
    await expect(ctaButton).toBeVisible();
  });

  test('FeatureCards render all 4 features', async ({ page }) => {
    await page.goto('/test-all-islands/');

    // Scroll to features section to trigger client:visible
    await page.locator('.bg-gray-50').scrollIntoViewIfNeeded();

    // Wait for hydration
    await page.waitForTimeout(1000);

    // Check all 4 feature cards are present
    const featureCards = page.locator('.bg-white.p-6.rounded-xl');
    await expect(featureCards).toHaveCount(4);

    // Check specific feature titles
    await expect(page.locator('text=Trip Planning & Management')).toBeVisible();
    await expect(page.locator('text=Real-time Communication')).toBeVisible();
    await expect(page.locator('text=Location Services')).toBeVisible();
    await expect(page.locator('text=Financial Management')).toBeVisible();
  });

  test('WaitlistForm is interactive', async ({ page }) => {
    await page.goto('/test-all-islands/');

    // Scroll to waitlist section
    await page.locator('#waitlist').scrollIntoViewIfNeeded();

    // Wait for hydration
    await page.waitForTimeout(1000);

    // Find email input
    const emailInput = page.locator('input[type="email"]');
    await expect(emailInput).toBeVisible();

    // Type in the input to verify interactivity
    await emailInput.fill('test@example.com');
    await expect(emailInput).toHaveValue('test@example.com');

    // Submit button should be visible
    const submitButton = page.locator('button[type="submit"]');
    await expect(submitButton).toBeVisible();
    await expect(submitButton).toContainText('Join Now');
  });

  test('Footer renders as static content', async ({ page }) => {
    await page.goto('/test-all-islands/');

    // Footer should be visible
    const footer = page.locator('footer');
    await expect(footer).toBeVisible();

    // Check copyright text
    await expect(footer).toContainText('NomadCrew');
    await expect(footer).toContainText('All rights reserved');
  });
});
```

Note: Uses page.waitForTimeout() for hydration delays. This is acceptable for testing client:visible/idle components that have inherent async behavior.
  </action>
  <verify>
1. File exists: ls tests/islands.spec.ts
2. TypeScript compiles: pnpm exec tsc --noEmit tests/islands.spec.ts (may need tsconfig adjustment)
3. Has all test cases: grep -c "test\\(" tests/islands.spec.ts (should be 6)
  </verify>
  <done>
- islands.spec.ts exists with 6 test cases
- Tests cover hydration errors, all 4 islands, and static Footer
- Tests use correct selectors and timeouts
  </done>
</task>

<task type="auto">
  <name>Task 3: Run Playwright tests and verify all pass</name>
  <files></files>
  <action>
Run the Playwright tests to verify all React islands work correctly.

Steps:
1. Start the dev server
2. Run the islands test suite
3. Verify all 6 tests pass
4. Check for any console warnings in test output

Commands:
```bash
# Make sure dev server is running in background
pnpm run dev &
DEV_PID=$!

# Wait for server to start
sleep 5

# Run Playwright tests for islands only
pnpm exec playwright test tests/islands.spec.ts --reporter=list

# Capture exit code
TEST_EXIT=$?

# Stop dev server
kill $DEV_PID 2>/dev/null

# Report result
if [ $TEST_EXIT -eq 0 ]; then
  echo "All tests passed successfully"
else
  echo "Tests failed with exit code $TEST_EXIT"
fi

# Exit with test result
exit $TEST_EXIT
```

If tests fail:
- Check console output for specific error messages
- Hydration errors indicate server/client mismatch
- Timeout errors may indicate slow hydration (increase wait times)
- Selector errors indicate component structure changed

All 6 tests must pass for this task to be complete.
  </action>
  <verify>
1. Run tests and confirm pass: pnpm exec playwright test tests/islands.spec.ts && echo "All tests passed"
2. All 6 tests pass (0 failures): pnpm exec playwright test tests/islands.spec.ts --reporter=list 2>&1 | grep -E "6 passed|passed.*6"
3. No "hydration" errors in console output
  </verify>
  <done>
- Playwright test suite runs successfully
- All 6 tests pass (exit code 0)
- No hydration mismatch errors detected
- All React islands verified functional
  </done>
</task>

</tasks>

<verification>
Complete phase verification:

```bash
# 1. All component files exist
echo "Checking component files..."
ls src/components/react/Navbar.tsx
ls src/components/react/HeroSection.tsx
ls src/components/react/FeatureCard.tsx
ls src/components/react/WaitlistForm.tsx
ls src/components/Footer.astro

# 2. TypeScript validation
echo "TypeScript check..."
pnpm run check

# 3. Run full Playwright test suite
echo "Running Playwright tests..."
pnpm run dev &
sleep 5
pnpm exec playwright test tests/islands.spec.ts --reporter=list && echo "All 6 tests passed"
kill %1

# 4. Verify test pass explicitly
echo "Verifying test results..."
pnpm exec playwright test tests/islands.spec.ts 2>&1 | grep -q "6 passed" && echo "Phase 4 verification COMPLETE"
```

Manual verification (for checkpoint):
1. Open http://localhost:4321/test-all-islands/
2. Watch Navbar slide down on page load
3. Scroll down to see FeatureCard animations trigger
4. Type in WaitlistForm email input
5. Open browser DevTools Console tab
6. Verify NO "hydration" errors appear
7. Refresh page and repeat - no errors should appear
</verification>

<success_criteria>
Phase 4 complete when all of the following are true:

1. **Component files exist:**
   - src/components/react/Navbar.tsx
   - src/components/react/HeroSection.tsx
   - src/components/react/FeatureCard.tsx
   - src/components/react/WaitlistForm.tsx
   - src/components/Footer.astro

2. **TypeScript validation:** pnpm run check passes

3. **Playwright tests pass:** All 6 tests in islands.spec.ts pass (exit code 0)

4. **Hydration directives correct:**
   - Navbar: client:load
   - HeroSection: client:idle
   - FeatureCard: client:visible
   - WaitlistForm: client:visible
   - Footer: No directive (static)

5. **No hydration errors:** Browser console shows no "hydration mismatch" messages

6. **Requirements satisfied:**
   - MIGR-02: Interactive components use React islands with selective hydration
   - PERF-05: Static components use Astro (Footer has no JS)
   - PERF-06: Interactive components use appropriate hydration directives
</success_criteria>

<output>
After completion, create `.planning/phases/04-react-islands-extraction/04-04-SUMMARY.md`

Phase 4 is complete. All React islands extracted and verified. Ready for Phase 5: Landing Page Assembly.
</output>
