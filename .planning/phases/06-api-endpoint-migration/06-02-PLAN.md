---
phase: 06-api-endpoint-migration
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - tests/waitlist-e2e.spec.ts
  - src/components/react/WaitlistForm.tsx
autonomous: true

must_haves:
  truths:
    - "Form submission with valid email shows success message"
    - "Form submission with invalid email shows validation error"
    - "Error states handle API failures gracefully with user-friendly messages"
  artifacts:
    - path: "tests/waitlist-e2e.spec.ts"
      provides: "End-to-end form submission tests"
      min_lines: 50
    - path: "src/components/react/WaitlistForm.tsx"
      provides: "Waitlist form with all error states"
      exports: ["default"]
  key_links:
    - from: "tests/waitlist-e2e.spec.ts"
      to: "src/components/react/WaitlistForm.tsx"
      via: "Playwright form interaction"
      pattern: "input\\[type=\"email\"\\]"
    - from: "src/components/react/WaitlistForm.tsx"
      to: "/api/waitlist"
      via: "fetch POST"
      pattern: "fetch\\('/api/waitlist'"
---

<objective>
Create end-to-end tests for the waitlist form submission flow and verify error handling

Purpose: Validate that the WaitlistForm component correctly handles all user interaction states (success, validation error, API error) as specified in the phase success criteria.

Output:
- `tests/waitlist-e2e.spec.ts` with comprehensive form submission tests
- Verified WaitlistForm error handling for all edge cases
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-api-endpoint-migration/06-RESEARCH.md
@.planning/phases/06-api-endpoint-migration/06-01-SUMMARY.md
@src/components/react/WaitlistForm.tsx
@tests/islands.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create end-to-end form submission tests</name>
  <files>tests/waitlist-e2e.spec.ts</files>
  <action>
Create `tests/waitlist-e2e.spec.ts` with comprehensive end-to-end tests for the waitlist form. These tests verify the UI behavior of the WaitlistForm component.

Test scenarios to cover (from Phase 6 success criteria):

1. **Valid email shows success state**
   - Navigate to page with WaitlistForm
   - Fill email input with valid email
   - Click submit button
   - Verify button changes to "Joining..." (loading state)
   - Mock or intercept API response with success
   - Verify success message appears ("Thank you for joining!")
   - Verify button shows "Joined Successfully!"
   - Verify input is cleared

2. **Empty email shows validation error**
   - Navigate to page with WaitlistForm
   - Leave email input empty
   - Click submit button
   - Verify error message "Please enter your email" appears
   - Verify button shows "Try Again"
   - Verify form did NOT make API call

3. **Invalid email (no @) shows validation error**
   - Navigate to page with WaitlistForm
   - Enter "invalidemail" (no @ symbol)
   - Click submit button
   - Verify error message "Please enter a valid email address" appears
   - Verify button shows "Try Again"

4. **API failure shows user-friendly error**
   - Use Playwright route interception to mock API failure
   - Enter valid email
   - Submit form
   - Verify error message displayed
   - Verify user can try again (button says "Try Again")

Use Playwright's `page.route()` to intercept `/api/waitlist` calls since Astro dev server doesn't serve the Pages Function. This allows testing the form's behavior without needing the actual API.

```typescript
await page.route('/api/waitlist', async (route) => {
  await route.fulfill({
    status: 200,
    contentType: 'application/json',
    body: JSON.stringify({ success: true, message: 'Successfully joined' })
  });
});
```

Test against the homepage (/) or /test-all-islands/ page which has the WaitlistForm.
  </action>
  <verify>
- `tests/waitlist-e2e.spec.ts` exists
- `pnpm run test tests/waitlist-e2e.spec.ts` passes all tests
- Tests cover: valid submission, empty email, invalid email, API failure
  </verify>
  <done>End-to-end form tests created and passing</done>
</task>

<task type="auto">
  <name>Task 2: Verify and improve error message handling</name>
  <files>src/components/react/WaitlistForm.tsx</files>
  <action>
Review WaitlistForm.tsx and verify all error states provide user-friendly messages:

1. **Verify existing error messages:**
   - Empty email: "Please enter your email" (line 16)
   - Invalid email: "Please enter a valid email address" (line 22)
   - API error: Uses error.message or "Something went wrong. Please try again." (line 50)

2. **Check for missing error handling:**
   - Network failure (fetch throws)
   - Unexpected response format (response.json() throws)
   - Rate limiting (429 status from Resend)

3. **Improve error messages if needed:**
   - If rate limited (429): "Too many requests. Please wait a moment and try again."
   - If network error: "Network error. Please check your connection and try again."
   - Ensure all error messages are user-friendly (no technical jargon)

4. **Verify visual error states:**
   - Error button is red (bg-red-500)
   - Error message text is red (text-red-500)
   - Button shows "Try Again" in error state

If WaitlistForm already handles all cases correctly, document this in the summary. Only modify if there are gaps in error handling.
  </action>
  <verify>
- WaitlistForm handles: empty email, invalid email, API 4xx, API 5xx, network failure
- All error messages are user-friendly (no "undefined" or technical errors shown)
- `pnpm run test` passes (no regressions)
  </verify>
  <done>WaitlistForm error handling verified comprehensive and user-friendly</done>
</task>

<task type="auto">
  <name>Task 3: Document CORS behavior and production readiness</name>
  <files>tests/waitlist-e2e.spec.ts</files>
  <action>
Add a test that documents the expected CORS behavior for the API endpoint:

1. **Same-origin behavior (production)**
   The form on nomadcrew.uk calls /api/waitlist on nomadcrew.uk - same origin, no CORS preflight needed. Document this in a comment.

2. **Add CORS documentation test:**
   ```typescript
   test.describe('API CORS Configuration', () => {
     test('documents production CORS behavior', async () => {
       // In production, form and API are same-origin (nomadcrew.uk)
       // CORS headers are set but not strictly necessary for same-origin requests
       // Headers allow cross-origin for flexibility (CDN, preview deployments)
       expect(true).toBe(true); // Documentation test
     });
   });
   ```

3. **Verify success criteria mapping:**
   Add comments mapping tests to Phase 6 success criteria:
   - SC1: Form submission with valid email returns success message
   - SC2: Form submission with invalid email shows validation error
   - SC3: Email confirmation delivers (tested manually with real API key)
   - SC4: Error states handle API failures gracefully
   - SC5: CORS headers allow requests from production domain

4. **Add test summary at top of file:**
   ```typescript
   /**
    * Waitlist Form End-to-End Tests
    *
    * Tests the WaitlistForm component's behavior for all user interaction scenarios.
    * API calls are mocked using Playwright's route interception since Astro dev
    * server doesn't serve Cloudflare Pages Functions.
    *
    * For real API testing, see tests/api.spec.ts and use wrangler pages dev.
    *
    * Success Criteria Coverage:
    * - SC1: Valid email success message - test "shows success message"
    * - SC2: Invalid email validation error - tests "empty email" and "invalid email"
    * - SC3: Email delivery - manual test with real RESEND_API_KEY
    * - SC4: Error handling - test "handles API failure gracefully"
    * - SC5: CORS headers - documented in CORS configuration section
    */
   ```
  </action>
  <verify>
- tests/waitlist-e2e.spec.ts has success criteria mapping in comments
- CORS behavior documented
- `pnpm run test` passes
  </verify>
  <done>CORS behavior and success criteria mapping documented in tests</done>
</task>

</tasks>

<verification>
1. `tests/waitlist-e2e.spec.ts` exists with all test scenarios
2. `pnpm run test tests/waitlist-e2e.spec.ts` passes
3. WaitlistForm handles all error states gracefully
4. Success criteria are mapped to specific tests
5. CORS behavior is documented
</verification>

<success_criteria>
1. Form shows success message for valid email (mocked API)
2. Form shows validation error for empty/invalid email
3. Form handles API failures with user-friendly message
4. All tests pass with `pnpm run test`
5. Success criteria from Phase 6 are explicitly covered
</success_criteria>

<output>
After completion, create `.planning/phases/06-api-endpoint-migration/06-02-SUMMARY.md`
</output>
