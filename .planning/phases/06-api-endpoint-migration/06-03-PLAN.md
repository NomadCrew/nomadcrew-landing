---
phase: 06-api-endpoint-migration
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Email confirmation delivers to submitted address within 60 seconds"
    - "Production deployment serves /api/waitlist correctly"
    - "CORS headers allow requests from production domain"
  artifacts: []
  key_links:
    - from: "WaitlistForm"
      to: "Cloudflare Pages Function"
      via: "Production deployment"
      pattern: "nomadcrew\\.uk/api/waitlist"
---

<objective>
Verify production deployment with real API key and email delivery

Purpose: Complete Phase 6 by verifying the waitlist endpoint works end-to-end in production with real email delivery via Resend.

Output:
- Verified email delivery to test address
- Documented production deployment status
- Phase 6 completion confirmed
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-api-endpoint-migration/06-RESEARCH.md
@.planning/phases/06-api-endpoint-migration/06-01-SUMMARY.md
@.planning/phases/06-api-endpoint-migration/06-02-SUMMARY.md
@functions/api/waitlist.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy to Cloudflare Pages and verify API accessible</name>
  <files></files>
  <action>
1. Build the project: `pnpm run build`

2. Deploy to Cloudflare Pages preview:
   `wrangler pages deploy ./dist --project-name nomadcrew-landing-page`

3. Verify deployment succeeded and note the preview URL

4. Test API endpoint accessibility with curl:
   ```bash
   curl -X OPTIONS https://[preview-url]/api/waitlist -v
   ```
   Expected: 204 response with CORS headers

5. Test API endpoint with invalid request (no API key configured yet):
   ```bash
   curl -X POST https://[preview-url]/api/waitlist \
     -H "Content-Type: application/json" \
     -d '{"email":"test@example.com"}'
   ```
   Expected: 500 "Server configuration error" (RESEND_API_KEY not set)

6. Record the preview deployment URL for checkpoint verification
  </action>
  <verify>
- Build succeeds with `pnpm run build`
- Deployment succeeds with wrangler pages deploy
- Preview URL is accessible
- /api/waitlist returns CORS headers on OPTIONS
- /api/waitlist returns 500 (expected - no API key in preview)
  </verify>
  <done>Preview deployment verified, API endpoint accessible (awaiting production API key)</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
API endpoint deployed to Cloudflare Pages preview. The endpoint is accessible but returns "Server configuration error" because RESEND_API_KEY is not configured in Cloudflare dashboard.
  </what-built>
  <how-to-verify>
**Step 1: Configure RESEND_API_KEY in Cloudflare Dashboard**
1. Go to Cloudflare Dashboard -> Pages -> nomadcrew-landing-page
2. Navigate to Settings -> Environment variables
3. Add variable:
   - Name: `RESEND_API_KEY`
   - Value: Your Resend API key (get from https://resend.com/api-keys)
   - Environment: Production (and Preview if testing)
4. Click Save

**Step 2: Redeploy to Pick Up Environment Variable**
After adding the env var, either:
- Trigger a new deployment from the dashboard, OR
- Wait for Claude to run `wrangler pages deploy` again

**Step 3: Test Email Delivery**
1. Visit the production site or preview URL
2. Scroll to the waitlist section
3. Enter your email address
4. Click "Join Now"
5. Check your inbox for the welcome email (should arrive within 60 seconds)
6. Verify email content matches expected format (NomadCrew branding, welcome message)

**Expected Result:**
- Form shows "Joined Successfully!" after submission
- Email arrives with subject "Welcome to NomadCrew Waitlist!"
- Email contains welcome message and feature list

**If email doesn't arrive:**
- Check spam folder
- Verify RESEND_API_KEY is correct
- Check Cloudflare Pages function logs in dashboard
  </how-to-verify>
  <resume-signal>Type "email-verified" with your test email domain (e.g., "email-verified gmail") or describe any issues</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Document production verification results</name>
  <files></files>
  <action>
Based on checkpoint feedback, document the verification results:

1. If email-verified:
   - Note which email provider was tested (Gmail, Outlook, etc.)
   - Confirm delivery time (should be under 60 seconds)
   - Confirm email content is correct

2. If issues encountered:
   - Document the error and resolution
   - Note any configuration changes made

3. Verify all Phase 6 success criteria are met:
   - [ ] SC1: Form submission with valid email returns success message
   - [ ] SC2: Form submission with invalid email shows validation error
   - [ ] SC3: Email confirmation delivers within 60 seconds
   - [ ] SC4: Error states handle API failures gracefully
   - [ ] SC5: CORS headers allow requests from production domain

4. Run final test suite to confirm no regressions:
   `pnpm run test`
  </action>
  <verify>
- All Phase 6 success criteria documented as met
- Test email delivered successfully
- `pnpm run test` passes
  </verify>
  <done>Phase 6 production verification complete, all success criteria met</done>
</task>

</tasks>

<verification>
1. Cloudflare Pages deployment successful
2. RESEND_API_KEY configured in dashboard
3. Test email delivered within 60 seconds
4. Email content correct (NomadCrew branding)
5. All automated tests pass
6. All Phase 6 success criteria verified
</verification>

<success_criteria>
1. Production API endpoint returns 200 for valid submissions
2. Email confirmation delivered to test address
3. Email delivery time under 60 seconds
4. CORS headers present on all API responses
5. Phase 6 requirements (MIGR-05) marked complete
</success_criteria>

<output>
After completion, create `.planning/phases/06-api-endpoint-migration/06-03-SUMMARY.md`
</output>
