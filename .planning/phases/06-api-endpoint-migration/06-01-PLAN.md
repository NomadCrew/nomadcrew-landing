---
phase: 06-api-endpoint-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .dev.vars
  - .gitignore
  - tests/api.spec.ts
autonomous: true
user_setup:
  - service: resend
    why: "Email delivery for waitlist confirmation"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
    dashboard_config: []

must_haves:
  truths:
    - "Local development can test API endpoint with wrangler"
    - "Environment variable RESEND_API_KEY accessible in local dev"
    - "Playwright tests verify API response structure"
  artifacts:
    - path: ".dev.vars"
      provides: "Local environment variables for Cloudflare Pages Functions"
      contains: "RESEND_API_KEY"
    - path: "tests/api.spec.ts"
      provides: "API endpoint tests for waitlist signup"
      exports: []
  key_links:
    - from: ".dev.vars"
      to: "functions/api/waitlist.ts"
      via: "context.env binding"
      pattern: "context\\.env\\.RESEND_API_KEY"
---

<objective>
Set up local development environment for API testing and create Playwright tests for waitlist endpoint

Purpose: Enable local testing of the existing Cloudflare Pages Function with real environment variables, and establish automated API tests for all success criteria.

Output:
- `.dev.vars` file for local environment variables (gitignored)
- Updated `.gitignore` to exclude `.dev.vars`
- `tests/api.spec.ts` with Playwright API tests for waitlist endpoint
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-api-endpoint-migration/06-RESEARCH.md
@functions/api/waitlist.ts
@src/components/react/WaitlistForm.tsx
@playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .dev.vars and update .gitignore</name>
  <files>.dev.vars, .gitignore</files>
  <action>
1. Create `.dev.vars` file in project root with placeholder for RESEND_API_KEY:
   ```
   # Local development environment variables for Cloudflare Pages Functions
   # Get your API key from: https://resend.com/api-keys
   RESEND_API_KEY=re_your_api_key_here
   ```

2. Add `.dev.vars` to `.gitignore` if not already present (it's a secrets file)

3. Verify wrangler can read the environment by running:
   - `pnpm run build`
   - `wrangler pages dev ./dist` (should start without errors)
   - Check console for "[Waitlist]" log prefix availability

Note: The placeholder value will cause "Server configuration error" responses until user provides real API key. This is expected and tested in Task 2.
  </action>
  <verify>
- `.dev.vars` exists in project root
- `.gitignore` contains `.dev.vars` entry
- `wrangler pages dev ./dist` starts successfully on port 8788
  </verify>
  <done>.dev.vars template created and gitignored, wrangler local preview works</done>
</task>

<task type="auto">
  <name>Task 2: Create Playwright API tests for waitlist endpoint</name>
  <files>tests/api.spec.ts</files>
  <action>
Create `tests/api.spec.ts` with Playwright API tests. These tests run against the Astro dev server (port 4321), which does NOT serve the Pages Function. For full API testing, use wrangler.

Tests to create:

1. **Client-side validation tests** (run against Astro dev server):
   - Empty email shows error message in UI
   - Invalid email (no @) shows error message in UI
   - Valid email triggers form submission attempt

2. **Mock API behavior tests** (document what production API should do):
   - POST /api/waitlist with valid email returns 200 + success: true
   - POST /api/waitlist with empty body returns 400 + error message
   - POST /api/waitlist with invalid JSON returns 400
   - OPTIONS /api/waitlist returns 204 with CORS headers
   - GET /api/waitlist returns 405 Method Not Allowed

Note: The Astro dev server does NOT serve `functions/` directory. Tests that need actual API responses must use `wrangler pages dev`. Mark these as skipped with a note about manual testing with wrangler.

Test structure:
```typescript
import { test, expect } from '@playwright/test';

test.describe('Waitlist API - Client Validation', () => {
  // Tests that work with Astro dev server
});

test.describe.skip('Waitlist API - Server Responses', () => {
  // Tests that require wrangler pages dev
  // Skip in CI, document manual testing procedure
});
```

Use `test.describe.skip` for server-side tests and add a comment explaining they require `wrangler pages dev ./dist` on port 8788.
  </action>
  <verify>
- `tests/api.spec.ts` exists
- `pnpm run test` includes new tests (client validation tests pass)
- Skipped tests are clearly documented with manual testing instructions
  </verify>
  <done>API test file created with client validation tests passing and server tests documented</done>
</task>

<task type="auto">
  <name>Task 3: Create wrangler test script and verify API locally</name>
  <files>package.json</files>
  <action>
1. Add a `test:api` script to package.json that:
   - Builds the project
   - Runs wrangler pages dev in background
   - Waits for server to be ready
   - Runs only api.spec.ts tests
   - Kills wrangler after tests

   Since background processes are complex in npm scripts, create a simpler approach:
   - Add `test:api:manual` script with instructions
   - Document the manual testing process

2. Add to package.json scripts:
   ```json
   "test:api:manual": "echo 'Run: pnpm build && wrangler pages dev ./dist' in one terminal, then 'pnpm test tests/api.spec.ts' in another"
   ```

3. Verify API works locally with wrangler:
   - Run `pnpm run build`
   - Run `wrangler pages dev ./dist` (starts on http://localhost:8788)
   - Use curl to test: `curl -X POST http://localhost:8788/api/waitlist -H "Content-Type: application/json" -d '{"email":"test@example.com"}'`
   - Expected: 500 error with "Server configuration error" (because .dev.vars has placeholder key)
   - This confirms the endpoint IS running and accessible

4. Document in tests/api.spec.ts header comment:
   ```
   // To run full API tests with wrangler:
   // 1. Update .dev.vars with real RESEND_API_KEY
   // 2. Terminal 1: pnpm build && wrangler pages dev ./dist
   // 3. Terminal 2: PLAYWRIGHT_BASE_URL=http://localhost:8788 pnpm test tests/api.spec.ts
   ```
  </action>
  <verify>
- package.json has test:api:manual script
- `wrangler pages dev ./dist` serves API at http://localhost:8788/api/waitlist
- curl POST to /api/waitlist returns JSON response (error expected with placeholder key)
  </verify>
  <done>Wrangler test script added, API endpoint verified accessible locally</done>
</task>

</tasks>

<verification>
1. `.dev.vars` exists with RESEND_API_KEY placeholder
2. `.gitignore` includes `.dev.vars`
3. `tests/api.spec.ts` exists with test cases
4. `pnpm run test` passes (client validation tests)
5. `wrangler pages dev ./dist` starts and serves /api/waitlist
6. curl to /api/waitlist returns JSON (even if error response)
</verification>

<success_criteria>
1. Local development environment configured for API testing
2. Playwright tests cover client-side email validation
3. Server-side API tests documented with manual testing procedure
4. Wrangler preview serves the Pages Function correctly
</success_criteria>

<output>
After completion, create `.planning/phases/06-api-endpoint-migration/06-01-SUMMARY.md`
</output>
