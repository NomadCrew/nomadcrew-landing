---
phase: 02-cloudflare-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - wrangler.jsonc
  - wrangler.toml
  - package.json
autonomous: false

must_haves:
  truths:
    - "Site builds successfully with Astro"
    - "Build output contains .well-known files"
    - "Local preview serves pages correctly via Wrangler"
    - "Cloudflare Auto Minify is disabled on custom domain"
  artifacts:
    - path: "wrangler.jsonc"
      provides: "Cloudflare Pages configuration"
      contains: "pages_build_output_dir"
    - path: "dist/index.html"
      provides: "Built site entry point"
      min_lines: 10
    - path: "dist/.well-known/apple-app-site-association"
      provides: "iOS deep linking file in build"
    - path: "dist/.well-known/assetlinks.json"
      provides: "Android deep linking file in build"
  key_links:
    - from: "wrangler.jsonc"
      to: "dist/"
      via: "pages_build_output_dir setting"
      pattern: '"pages_build_output_dir".*"\\./dist"'
    - from: "public/.well-known/*"
      to: "dist/.well-known/*"
      via: "Astro static asset copy"
      pattern: "dist/.well-known"
---

<objective>
Configure Cloudflare Pages deployment for static Astro site

Purpose: Validate that the Astro build output is correctly configured for Cloudflare Pages deployment before migrating content. This ensures the deployment pipeline works with the new framework.

Output: Working Cloudflare configuration with verified local preview and build output ready for production deployment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cloudflare-integration/02-RESEARCH.md

# Key context from research
# - Static sites (output: 'static') do NOT need @astrojs/cloudflare adapter
# - wrangler.jsonc is recommended over wrangler.toml for new projects
# - _routes.json may not be generated for static sites (only for SSR)
# - nodejs_compat flag not needed for static sites (add in Phase 6 if API endpoints require it)
# - Auto Minify deprecated Aug 2024 but may still be enabled on existing custom domains

@astro.config.mjs
@wrangler.toml
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate wrangler config and add Wrangler CLI</name>
  <files>wrangler.jsonc, wrangler.toml, package.json</files>
  <action>
1. Install wrangler as dev dependency:
   ```bash
   pnpm add -D wrangler
   ```

2. Create wrangler.jsonc with static site configuration:
   ```jsonc
   {
     "$schema": "https://json.schemastore.org/wrangler.json",
     "name": "nomadcrew-landing-page",
     "compatibility_date": "2026-01-29",
     "pages_build_output_dir": "./dist"
   }
   ```

   Note: Do NOT add compatibility_flags with nodejs_compat - not needed for static sites.
   This will be added in Phase 6 if API endpoints require Node.js runtime APIs.

3. Delete wrangler.toml (superseded by wrangler.jsonc)

4. Add preview:wrangler script to package.json:
   ```json
   "preview:wrangler": "wrangler pages dev ./dist"
   ```
   This provides Cloudflare-accurate local preview (vs astro preview which uses standard HTTP server).
  </action>
  <verify>
- wrangler.jsonc exists with pages_build_output_dir: "./dist"
- wrangler.toml is deleted
- pnpm list wrangler shows wrangler installed
- package.json contains preview:wrangler script
  </verify>
  <done>
Wrangler CLI installed and configured with modern jsonc format. Old toml config removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build site and verify output structure</name>
  <files>dist/</files>
  <action>
1. Run Astro build:
   ```bash
   pnpm build
   ```

2. Verify build output structure:
   - dist/index.html exists (entry point)
   - dist/.well-known/apple-app-site-association exists (iOS deep linking)
   - dist/.well-known/assetlinks.json exists (Android deep linking)
   - dist/_astro/ directory exists (compiled assets)

3. Check for _routes.json:
   - If dist/_routes.json exists, verify it has fewer than 100 rules
   - If it doesn't exist, that's expected for static sites (no action needed)

4. Verify no adapter-related files:
   - dist/_worker.js should NOT exist (that would indicate SSR mode)
  </action>
  <verify>
- pnpm build completes without errors
- ls dist/index.html succeeds
- ls dist/.well-known/apple-app-site-association succeeds
- ls dist/.well-known/assetlinks.json succeeds
- dist/_worker.js does NOT exist (confirms static mode)
  </verify>
  <done>
Build output validated: entry point exists, .well-known files copied, static mode confirmed (no _worker.js).
  </done>
</task>

<task type="auto">
  <name>Task 3: Test local preview with Wrangler</name>
  <files>none</files>
  <action>
1. Start Wrangler Pages dev server:
   ```bash
   pnpm preview:wrangler
   ```

2. Verify the following endpoints are accessible:
   - http://localhost:8788/ returns HTML (landing page)
   - http://localhost:8788/.well-known/apple-app-site-association returns JSON
   - http://localhost:8788/.well-known/assetlinks.json returns JSON

3. Stop the server after verification (Ctrl+C)

Note: Wrangler pages dev simulates the Cloudflare Pages runtime more accurately than astro preview,
catching potential deployment issues before pushing to production.
  </action>
  <verify>
- Wrangler server starts on port 8788
- curl http://localhost:8788/ returns HTML content
- curl http://localhost:8788/.well-known/apple-app-site-association returns valid JSON
  </verify>
  <done>
Local Cloudflare preview working. Site serves correctly, .well-known files accessible.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Cloudflare Pages configuration with wrangler.jsonc, verified build output, and local preview.
  </what-built>
  <how-to-verify>
**Part A: Verify Auto Minify is disabled (Cloudflare Dashboard)**

1. Log into Cloudflare Dashboard: https://dash.cloudflare.com
2. Select the nomadcrew.uk domain
3. Navigate to: Speed > Optimization > Content Optimization
4. Verify "Auto Minify" is disabled (all three checkboxes: JavaScript, CSS, HTML)
   - Note: This feature was deprecated August 2024, so it may already be disabled or removed
   - If the option doesn't appear at all, that's fine - it means it's fully deprecated

**Part B: Test deployment to Cloudflare Pages (optional but recommended)**

If you want to test deployment now:
```bash
npx wrangler pages deploy ./dist
```
- This will prompt for Cloudflare authentication if not already logged in
- Select or create a Pages project when prompted
- Verify the deployment URL works

If you prefer to test deployment later (via GitHub integration), that's also acceptable.

**Part C: Verify .well-known files (after deployment)**

If deployed, verify these URLs work on the deployed site:
- https://[deployed-url]/.well-known/apple-app-site-association
- https://[deployed-url]/.well-known/assetlinks.json
  </how-to-verify>
  <resume-signal>
Type "approved" if Auto Minify is disabled (or not present) and local preview works.
If you tested deployment, also confirm it succeeded.
If issues found, describe them.
  </resume-signal>
</task>

</tasks>

<verification>
Phase 2 success criteria validation:

1. Build output includes _routes.json with fewer than 100 rules
   - OR _routes.json not generated (expected for static sites)
   - Verify: ls dist/_routes.json || echo "Not generated (expected)"

2. wrangler.jsonc contains correct configuration
   - Verify: cat wrangler.jsonc | grep pages_build_output_dir

3. Test deployment to Cloudflare Pages succeeds
   - Verify: Manual checkpoint or npx wrangler pages deploy ./dist

4. .well-known files appear in deployed build
   - Verify: ls dist/.well-known/ and deployment test

5. Cloudflare Auto Minify is disabled in dashboard settings
   - Verify: Manual checkpoint (human verification in dashboard)
</verification>

<success_criteria>
- wrangler.jsonc exists with pages_build_output_dir: "./dist"
- pnpm build completes successfully
- dist/ contains index.html and .well-known files
- dist/_worker.js does NOT exist (confirms static mode)
- Local Wrangler preview serves site correctly
- Auto Minify verified disabled in Cloudflare dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/02-cloudflare-integration/02-01-SUMMARY.md`
</output>
